// Define the `main` function

const proxyName = "代理模式";

function main(params) {
    if (!params.proxies) return params;
    overwriteRules(params);
    overwriteProxyGroups(params);
    overwriteDns(params);
    return params;
}
//覆写规则
function overwriteRules(params) {
    const customRules = [
      // 在此添加自定义规则, 最高优先级。
      // 为了方便区分，可设置 全局代理模式 或 自定义代理组。
      // 示例1 ：使用 全局代理模式
      //"DOMAIN-SUFFIX,linux.do," + proxyName,
      // 示例2 ：使用 自定义代理组1
        "DOMAIN-SUFFIX,linux.do,linux.do",
        "DOMAIN-SUFFIX,idcflare.com,linux.do",
      // 示例3 ：使用 自定义代理组2
      //"DOMAIN-SUFFIX,googleapis.com,自定义代理组2",
    ];


    const rules = [
        ...customRules,
        "RULE-SET,private,DIRECT",
        "RULE-SET,lancidr,DIRECT",
        "GEOIP,LAN,DIRECT,no-resolve",
        "RULE-SET,reject,广告拦截",
        "RULE-SET,applications,DIRECT",
        "RULE-SET,direct,DIRECT",
        "RULE-SET,cncidr,DIRECT",
        "GEOIP,CN,DIRECT,no-resolve",
        "RULE-SET,openai,ChatGPT",
        "RULE-SET,claude,Claude",
        "RULE-SET,spotify,Spotify",
        "RULE-SET,youtube,YouTube",
        "RULE-SET,youtubemusic,YouTube",
        "RULE-SET,telegramcidr,电报消息,no-resolve",
        "RULE-SET,google," + proxyName,
        "RULE-SET,icloud," + proxyName,
        "RULE-SET,apple," + proxyName,
        "RULE-SET,gfw," + proxyName,
        "RULE-SET,greatfire," + proxyName,
        "RULE-SET,proxy," + proxyName,
        "RULE-SET,tld-not-cn," + proxyName,
        "MATCH,漏网之鱼",
    ];
    const ruleProviders = {
        reject: {
            type: "http",
            behavior: "domain",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt",
            path: "./ruleset/reject.yaml",
            interval: 86400,
        },
        icloud: {
            type: "http",
            behavior: "domain",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/icloud.txt",
            path: "./ruleset/icloud.yaml",
            interval: 86400,
        },
        apple: {
            type: "http",
            behavior: "domain",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/apple.txt",
            path: "./ruleset/apple.yaml",
            interval: 86400,
        },
        google: {
            type: "http",
            behavior: "domain",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/google.txt",
            path: "./ruleset/google.yaml",
            interval: 86400,
        },
        proxy: {
            type: "http",
            behavior: "domain",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt",
            path: "./ruleset/proxy.yaml",
            interval: 86400,
        },
        openai: {
            type: "http",
            behavior: "classical",
            url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/OpenAI/OpenAI.yaml",
            path: "./ruleset/custom/openai.yaml"
        },
        claude: {
            type: "http",
            behavior: "classical",
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Claude/Claude.yaml",
            path: "./ruleset/custom/Claude.yaml"
        },
        spotify: {
            type: "http",
            behavior: "classical",
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Spotify/Spotify.yaml",
            path: "./ruleset/custom/Spotify.yaml"
        },
        youtube: {
            type: "http",
            behavior: "classical",
            url: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/YouTube/YouTube.yaml",
            path: "./ruleset/custom/YouTube.yaml"
        },
        youtubemusic: {
            type: "http",
            behavior: "classical",
            url: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/YouTubeMusic/YouTubeMusic.yaml",
            path: "./ruleset/custom/YouTubeMusic.yaml"
        },
        direct: {
            type: "http",
            behavior: "domain",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt",
            path: "./ruleset/direct.yaml",
            interval: 86400,
        },
        private: {
            type: "http",
            behavior: "domain",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/private.txt",
            path: "./ruleset/private.yaml",
            interval: 86400,
        },
        gfw: {
            type: "http",
            behavior: "domain",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/gfw.txt",
            path: "./ruleset/gfw.yaml",
            interval: 86400,
        },
        greatfire: {
            type: "http",
            behavior: "domain",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/greatfire.txt",
            path: "./ruleset/greatfire.yaml",
            interval: 86400,
        },
        "tld-not-cn": {
            type: "http",
            behavior: "domain",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/tld-not-cn.txt",
            path: "./ruleset/tld-not-cn.yaml",
            interval: 86400,
        },
        telegramcidr: {
            type: "http",
            behavior: "ipcidr",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt",
            path: "./ruleset/telegramcidr.yaml",
            interval: 86400,
        },
        cncidr: {
            type: "http",
            behavior: "ipcidr",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt",
            path: "./ruleset/cncidr.yaml",
            interval: 86400,
        },
        lancidr: {
            type: "http",
            behavior: "ipcidr",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt",
            path: "./ruleset/lancidr.yaml",
            interval: 86400,
        },
        applications: {
            type: "http",
            behavior: "classical",
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt",
            path: "./ruleset/applications.yaml",
            interval: 86400,
        },
    };
    params["rule-providers"] = ruleProviders;
    params["rules"] = rules;
}
//覆写代理组
function overwriteProxyGroups(params) {
    // 添加自用代理
    params.proxies.push(
        //  { name: '1-香港-示例', type: *, server: **, port: *, cipher: **, password: **, udp: true }

    );

    // 所有代理
    const allProxies = params["proxies"].map((e) => e.name);
    // 自动选择代理组，按地区分组选延迟最低
    const autoProxyGroupRegexs = [
        { name: "HK香港-自动选择", regex: /香港|(?<![a-zA-Z])(?:HK)(?![a-zA-Z])|Hong|🇭🇰/i },
        { name: "TW台湾-自动选择", regex: /台湾|(?<![a-zA-Z])(?:TW)(?![a-zA-Z])|Taiwan|Wan|🇨🇳|🇹🇼/i },
        { name: "SG新加坡-自动选择", regex: /新加坡|(?<![a-zA-Z])(?:SG)(?![a-zA-Z])|Singapore|🇸🇬/i },
        { name: "JP日本-自动选择", regex: /日本|(?<![a-zA-Z])(?:JP)(?![a-zA-Z])|Japan|🇯🇵/i },
        { name: "US美国-自动选择", regex: /美国|(?<![a-zA-Z])(?:US)(?![a-zA-Z])|United States|America|🇺🇸/i },
        { name: "KR韩国-自动选择", regex: /韩国|(?<![a-zA-Z])(?:KR)(?![a-zA-Z])|Korea|🇰🇷/i },
        { name: "GB英国-自动选择", regex: /英国|(?<![a-zA-Z])(?:UK|GB)(?![a-zA-Z])|United Kingdom|🇬🇧/i },
        { name: "AU澳大利亚-自动选择", regex: /澳大利亚|澳洲|(?<![a-zA-Z])(?:AU)(?![a-zA-Z])|Australia|🇦🇺/i },
        { name: "DE德国-自动选择", regex: /德国|(?<![a-zA-Z])(?:DE)(?![a-zA-Z])|Germany|🇩🇪/i },
        { name: "CA加拿大-自动选择", regex: /加拿大|(?<![a-zA-Z])(?:CA)(?![a-zA-Z])|Canada|🇨🇦/i },
        { name: "AR阿根廷-自动选择", regex: /阿根廷|(?<![a-zA-Z])(?:AR)(?![a-zA-Z])|Argentina|🇦🇷/i },
        { name: "ES西班牙-自动选择", regex: /西班牙|(?<![a-zA-Z])(?:ES)(?![a-zA-Z])|Spain|🇪🇸/i },
        { name: "NL荷兰-自动选择", regex: /荷兰|(?<![a-zA-Z])(?:NL)(?![a-zA-Z])|Netherlands|🇳🇱/i },
        { name: "TR土耳其-自动选择", regex: /土耳其|(?<![a-zA-Z])(?:TR)(?![a-zA-Z])|Turkey|🇹🇷/i },
        { name: "RU俄罗斯-自动选择", regex: /俄罗斯|(?<![a-zA-Z])(?:RU)(?![a-zA-Z])|Russia|🇷🇺/i },
        { name: "IN印度-自动选择", regex: /印度|(?<![a-zA-Z])(?:IN)(?![a-zA-Z])|India|🇮🇳/i },
        { name: "BR巴西-自动选择", regex: /巴西|(?<![a-zA-Z])(?:BR)(?![a-zA-Z])|Brazil|🇧🇷/i },
        { name: "IT意大利-自动选择", regex: /意大利|(?<![a-zA-Z])(?:IT)(?![a-zA-Z])|Italy|🇮🇹/i },
        { name: "CH瑞士-自动选择", regex: /瑞士|(?<![a-zA-Z])(?:CH)(?![a-zA-Z])|Switzerland|🇨🇭/i },
        { name: "SE瑞典-自动选择", regex: /瑞典|(?<![a-zA-Z])(?:SE)(?![a-zA-Z])|Sweden|🇸🇪/i },
        { name: "NO挪威-自动选择", regex: /挪威|(?<![a-zA-Z])(?:NO)(?![a-zA-Z])|Norway|🇳🇴/i },
        { name: "CN中国-自动选择", regex: /中国|(?<![a-zA-Z])(?:CN)(?![a-zA-Z])|China|PRC|🇨🇳/i },
        { name: "VN越南-自动选择", regex: /越南|(?<![a-zA-Z])(?:VN)(?![a-zA-Z])|Vietnam|🇻🇳/i },
        { name: "FR法国-自动选择", regex: /法国|(?<![a-zA-Z])(?:FR)(?![a-zA-Z])|France|🇫🇷/i },
        { name: "MY马来西亚-自动选择", regex: /马来西亚|(?<![a-zA-Z])(?:MY)(?![a-zA-Z])|Malaysia|🇲🇾/i },
        { name: "TH泰国-自动选择", regex: /泰国|(?<![a-zA-Z])(?:TH)(?![a-zA-Z])|Thailand|🇹🇭/i },
        { name: "PH菲律宾-自动选择", regex: /菲律宾|(?<![a-zA-Z])(?:PH)(?![a-zA-Z])|Philippines|🇵🇭/i },
        { name: "其它-自动选择", regex: /(?!.*(?:剩余|到期|主页|官网|游戏|关注))(.*)/i },

    ];

    const autoProxyGroups = autoProxyGroupRegexs
        .map((item) => ({
            name: item.name,
            type: "url-test",
            url: "http://www.gstatic.com/generate_204",
            interval: 300,
            tolerance: 50,
            proxies: getProxiesByRegex(params, item.regex),
            hidden: true,
        }))
        .filter((item) => item.proxies.length > 0);

    //手工选择代理组
    const manualProxyGroups = [
        { name: "HK香港-手工选择", regex: /香港|(?<![a-zA-Z])(?:HK)(?![a-zA-Z])|Hong|🇭🇰/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/hk.svg" },
        { name: "TW台湾-手工选择", regex: /台湾|(?<![a-zA-Z])(?:TW)(?![a-zA-Z])|Taiwan|Wan|🇨🇳|🇹🇼/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/tw.svg" },
        { name: "SG新加坡-手工选择", regex: /新加坡|(?<![a-zA-Z])(?:SG)(?![a-zA-Z])|Singapore|🇸🇬/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/sg.svg" },
        { name: "JP日本-手工选择", regex: /日本|(?<![a-zA-Z])(?:JP)(?![a-zA-Z])|Japan|🇯🇵/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/jp.svg" },
        { name: "US美国-手工选择", regex: /美国|(?<![a-zA-Z])(?:US)(?![a-zA-Z])|United States|America|🇺🇸/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/us.svg" },
        { name: "KR韩国-手工选择", regex: /韩国|(?<![a-zA-Z])(?:KR)(?![a-zA-Z])|Korea|🇰🇷/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/kr.svg" },
        { name: "GB英国-手工选择", regex: /英国|(?<![a-zA-Z])(?:UK|GB)(?![a-zA-Z])|United Kingdom|🇬🇧/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/gb.svg" },
        { name: "AU澳大利亚-手工选择", regex: /澳大利亚|澳洲|(?<![a-zA-Z])(?:AU)(?![a-zA-Z])|Australia|🇦🇺/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/au.svg" },
        { name: "DE德国-手工选择", regex: /德国|(?<![a-zA-Z])(?:DE)(?![a-zA-Z])|Germany|🇩🇪/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/de.svg" },
        { name: "CA加拿大-手工选择", regex: /加拿大|(?<![a-zA-Z])(?:CA)(?![a-zA-Z])|Canada|🇨🇦/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/ca.svg" },
        { name: "AR阿根廷-手工选择", regex: /阿根廷|(?<![a-zA-Z])(?:AR)(?![a-zA-Z])|Argentina|🇦🇷/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/ar.svg" },
        { name: "ES西班牙-手工选择", regex: /西班牙|(?<![a-zA-Z])(?:ES)(?![a-zA-Z])|Spain|🇪🇸/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/es.svg" },
        { name: "NL荷兰-手工选择", regex: /荷兰|(?<![a-zA-Z])(?:NL)(?![a-zA-Z])|Netherlands|🇳🇱/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/nl.svg" },
        { name: "TR土耳其-手工选择", regex: /土耳其|(?<![a-zA-Z])(?:TR)(?![a-zA-Z])|Turkey|🇹🇷/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/tr.svg" },
        { name: "RU俄罗斯-手工选择", regex: /俄罗斯|(?<![a-zA-Z])(?:RU)(?![a-zA-Z])|Russia|🇷🇺/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/ru.svg" },
        { name: "IN印度-手工选择", regex: /印度|(?<![a-zA-Z])(?:IN)(?![a-zA-Z])|India|🇮🇳/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/in.svg" },
        { name: "BR巴西-手工选择", regex: /巴西|(?<![a-zA-Z])(?:BR)(?![a-zA-Z])|Brazil|🇧🇷/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/br.svg" },
        { name: "IT意大利-手工选择", regex: /意大利|(?<![a-zA-Z])(?:IT)(?![a-zA-Z])|Italy|🇮🇹/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/it.svg" },
        { name: "CH瑞士-手工选择", regex: /瑞士|(?<![a-zA-Z])(?:CH)(?![a-zA-Z])|Switzerland|🇨🇭/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/ch.svg" },
        { name: "SE瑞典-手工选择", regex: /瑞典|(?<![a-zA-Z])(?:SE)(?![a-zA-Z])|Sweden|🇸🇪/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/se.svg" },
        { name: "NO挪威-手工选择", regex: /挪威|(?<![a-zA-Z])(?:NO)(?![a-zA-Z])|Norway|🇳🇴/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/no.svg" },
        { name: "CN中国-手工选择", regex: /中国|(?<![a-zA-Z])(?:CN)(?![a-zA-Z])|China|PRC|🇨🇳/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/cn.svg" },
        { name: "VN越南-手工选择", regex: /越南|(?<![a-zA-Z])(?:VN)(?![a-zA-Z])|Vietnam|🇻🇳/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/vn.svg" },
        { name: "FR法国-手工选择", regex: /法国|(?<![a-zA-Z])(?:FR)(?![a-zA-Z])|France|🇫🇷/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/fr.svg" },
        { name: "MY马来西亚-手工选择", regex: /马来西亚|(?<![a-zA-Z])(?:MY)(?![a-zA-Z])|Malaysia|🇲🇾/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/my.svg" },
        { name: "TH泰国-手工选择", regex: /泰国|(?<![a-zA-Z])(?:TH)(?![a-zA-Z])|Thailand|🇹🇭/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/th.svg" },
        { name: "PH菲律宾-手工选择", regex: /菲律宾|(?<![a-zA-Z])(?:PH)(?![a-zA-Z])|Philippines|🇵🇭/i, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/ph.svg" },
    ];

    const manualProxyGroupsConfig = manualProxyGroups
        .map((item) => ({
            name: item.name,
            type: "select",
            proxies: getManualProxiesByRegex(params, item.regex),
            icon: item.icon,
            hidden: false,
        }))
        .filter((item) => item.proxies.length > 0);
const existingAutoGroups = autoProxyGroups.map(item => item.name);
const existingManualGroups = manualProxyGroupsConfig.map(item => item.name);

    const groups = [
        {
            name: proxyName,
            type: "select",
            url: "http://www.gstatic.com/generate_204",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/adjust.svg",
            proxies: [
                "自动选择",
                "手动选择",
                "负载均衡(散列)",
                "负载均衡(轮询)",
                "DIRECT",
            ],
        },
        {
            name: "手动选择",
            type: "select",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/link.svg",
            proxies: allProxies,
        },
        {
            name: "自动选择",
            type: "select",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/speed.svg",
            proxies: ["ALL-自动选择"],
        },
        {
            name: "负载均衡(散列)",
            type: "load-balance",
            url: "http://www.gstatic.com/generate_204",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/balance.svg",
            interval: 300,
            "max-failed-times": 3,
            strategy: "consistent-hashing",
            lazy: true,
            proxies: allProxies,
        },
        {
            name: "负载均衡(轮询)",
            type: "load-balance",
            url: "http://www.gstatic.com/generate_204",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/merry_go.svg",
            interval: 300,
            "max-failed-times": 3,
            strategy: "round-robin",
            lazy: true,
            proxies: allProxies,
        },
        {
            name: "ALL-自动选择",
            type: "url-test",
            url: "http://www.gstatic.com/generate_204",
            interval: 300,
            tolerance: 50,
            proxies: allProxies,
            hidden: true,
        },
        {
            name: "linux.do",
            type: "select",
            proxies: [proxyName, "DIRECT", "REJECT", ...existingAutoGroups, ...existingManualGroups],
            // "include-all": true, //需要显示所有节点就取消注释
            icon: "https://linux.do/logo-1024.svg"
        },
        {
            name: "电报消息",
            type: "select",
            proxies: [proxyName, ...existingAutoGroups, ...existingManualGroups],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/telegram.svg"
        },
        {
            name: "ChatGPT",
            type: "select",
            proxies: [proxyName, ...existingAutoGroups, ...existingManualGroups],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/chatgpt.svg"
        },
        {
            name: "Claude",
            type: "select",
            proxies: [proxyName, ...existingAutoGroups, ...existingManualGroups],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/claude.svg"
        },
        {
            name: "Spotify",
            type: "select",
            proxies: [proxyName, ...existingAutoGroups, ...existingManualGroups],
            // "include-all": true,
            icon: "https://storage.googleapis.com/spotifynewsroom-jp.appspot.com/1/2020/12/Spotify_Icon_CMYK_Green.png"
        },
        {
            name: "YouTube",
            type: "select",
            proxies: [proxyName, ...existingAutoGroups, ...existingManualGroups],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/youtube.svg"
        },
        {
            name: "漏网之鱼",
            type: "select",
            proxies: ["DIRECT", proxyName],
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/fish.svg"
        },
        {
            name: "广告拦截",
            type: "select",
            proxies: ["REJECT", "DIRECT", proxyName],
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/block.svg"
        },
    ];

    autoProxyGroups.length &&
        groups[2].proxies.unshift(...autoProxyGroups.map((item) => item.name));
    groups.push(...autoProxyGroups);
    groups.push(...manualProxyGroupsConfig);
    params["proxy-groups"] = groups;

}
//防止dns泄露
function overwriteDns(params) {
    const cnDnsList = [
        "https://223.5.5.5/dns-query",
        "https://1.12.12.12/dns-query",
    ];
    const trustDnsList = [
        'quic://dns.cooluc.com',
        "https://1.0.0.1/dns-query",
        "https://1.1.1.1/dns-query",
    ];

    const dnsOptions = {
        enable: true,
        "prefer-h3": true, // 如果DNS服务器支持DoH3会优先使用h3
        "default-nameserver": cnDnsList, // 用于解析其他DNS服务器、和节点的域名, 必须为IP, 可为加密DNS。注意这个只用来解析节点和其他的dns，其他网络请求不归他管
        nameserver: trustDnsList, // 其他网络请求都归他管

        // 这个用于覆盖上面的 nameserver
        "nameserver-policy": {
            //[combinedUrls]: notionDns,
            "geosite:cn": cnDnsList,
            "geosite:geolocation-!cn": trustDnsList,
            // 如果你有一些内网使用的DNS，应该定义在这里，多个域名用英文逗号分割
            // '+.公司域名.com, www.4399.com, +.baidu.com': '10.0.0.1'
        },
        fallback: trustDnsList,
        "fallback-filter": {
            geoip: true,
            //除了 geoip-code 配置的国家 IP, 其他的 IP 结果会被视为污染 geoip-code 配置的国家的结果会直接采用，否则将采用 fallback结果
            "geoip-code": "CN",
            //geosite 列表的内容被视为已污染，匹配到 geosite 的域名，将只使用 fallback解析，不去使用 nameserver
            geosite: ["gfw"],
            ipcidr: ["240.0.0.0/4"],
            domain: ["+.google.com", "+.facebook.com", "+.youtube.com"],
        },
    };

    // GitHub加速前缀
    const githubPrefix = "https://fastgh.lainbo.com/";

    // GEO数据GitHub资源原始下载地址
    const rawGeoxURLs = {
        geoip:
            "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat",
        geosite:
            "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat",
        mmdb: "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb",
    };

    // 生成带有加速前缀的GEO数据资源对象
    const accelURLs = Object.fromEntries(
        Object.entries(rawGeoxURLs).map(([key, githubUrl]) => [
            key,
            `${githubPrefix}${githubUrl}`,
        ])
    );

    const otherOptions = {
        "unified-delay": true,
        "tcp-concurrent": true,
        profile: {
            "store-selected": true,
            "store-fake-ip": true,
        },
        sniffer: {
            enable: true,
            sniff: {
                TLS: {
                    ports: [443, 8443],
                },
                HTTP: {
                    ports: [80, "8080-8880"],
                    "override-destination": true,
                },
            },
        },
        "geodata-mode": true,
        "geox-url": accelURLs,
    };

    params.dns = { ...params.dns, ...dnsOptions };
    Object.keys(otherOptions).forEach((key) => {
        params[key] = otherOptions[key];
    });
}

function getProxiesByRegex(params, regex) {
    const matchedProxies = params.proxies.filter((e) => regex.test(e.name)).map((e) => e.name);
    return matchedProxies;
//    return matchedProxies.length > 0 ? matchedProxies : ["手动选择"];
}

function getManualProxiesByRegex(params, regex) {
    const matchedProxies = params.proxies.filter((e) => regex.test(e.name)).map((e) => e.name);
    return matchedProxies;
//    return matchedProxies.length > 0 ? matchedProxies : ["DIRECT", "手动选择", proxyName];
}
